<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>MyBaby — Inscription / Connexion</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="inscription.css">
</head>
<body>
  <main class="center" role="main" aria-labelledby="page-title">
    <section class="card" aria-labelledby="page-title">
      <h1 id="page-title" class="brand">MyBaby</h1>

      <div class="switch" role="tablist" aria-label="Inscription ou connexion">
        <button id="btnRegister" class="switch-btn" role="tab" aria-selected="false">Inscription</button>
        <button id="btnLogin" class="switch-btn active" role="tab" aria-selected="true">Connexion</button>
      </div>

      <!-- INSCRIPTION -->
      <form id="registerForm" class="form" style="display:none" autocomplete="on" novalidate>
        <label for="regPseudo">Pseudo</label>
        <input id="regPseudo" name="pseudo" type="text" autocomplete="username" placeholder="Ex : amina" required>

        <label for="regEmail">Email (optionnel)</label>
        <input id="regEmail" name="email" type="email" autocomplete="email" placeholder="email@exemple.com">

        <label for="regPassword">Mot de passe</label>
        <input id="regPassword" name="password" type="password" autocomplete="new-password" placeholder="••••••••" required>

        <div class="actions">
          <button type="button" id="regCancel" class="btn ghost">Annuler</button>
          <button type="submit" class="btn primary">S'inscrire et se connecter</button>
        </div>
        <div id="regErr" class="msg error" role="alert" aria-live="polite"></div>
      </form>

      <!-- CONNEXION -->
      <form id="loginForm" class="form" autocomplete="on" novalidate>
        <label for="logUser">Pseudo ou email</label>
        <input id="logUser" name="user" type="text" autocomplete="username" placeholder="Ex : amina" required>

        <label for="logPassword">Mot de passe</label>
        <input id="logPassword" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required>

        <div class="actions">
          <button type="submit" class="btn primary">Se connecter</button>
        </div>
        <div id="loginErr" class="msg error" role="alert" aria-live="polite"></div>
      </form>

      <p class="info">En vous connectant, vous accédez à votre profil et pouvez organiser des matchs.</p>
    </section>
  </main>

  <script>
  (function(){
    'use strict';

    // noms de clé
    const USERS_KEY = 'mybaby_users';
    const CURRENT_KEY = 'mybaby_user';
    // page d'accueil (modifie si nécessaire)
    const HOME_PAGE = 'Accueil.html';

    const $ = id => document.getElementById(id);

    function avatarFor(name){
      const n = String(name||'user').replace(/\s+/g,'');
      let h = 0;
      for (let i = 0; i < n.length; i++) h = ((h<<5)-h) + n.charCodeAt(i);
      return 'https://i.pravatar.cc/120?img=' + (Math.abs(h) % 70 + 1);
    }

    function loadRegistered(){ try { return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); } catch(e){ return []; } }
    function saveRegistered(list){ try { localStorage.setItem(USERS_KEY, JSON.stringify(list)); } catch(e){} }
    function saveCurrent(user){ try { localStorage.setItem(CURRENT_KEY, JSON.stringify(user)); } catch(e){} }
    function getReturnTo(){ try { const u = new URL(location.href); return u.searchParams.get('returnTo'); } catch(e){ return null; } }
    function redirectTo(url){ try { location.assign(url); } catch(e) { location.href = url; } }

    // éléments DOM
    const btnReg = $('btnRegister');
    const btnLog = $('btnLogin');
    const regForm = $('registerForm');
    const loginForm = $('loginForm');
    const regErr = $('regErr');
    const loginErr = $('loginErr');
    const regCancel = $('regCancel');

    // UI : bascule entre inscription/connexion
    function showRegister(){
      if (btnReg) { btnReg.classList.add('active'); btnReg.setAttribute('aria-selected','true'); }
      if (btnLog)  { btnLog.classList.remove('active'); btnLog.setAttribute('aria-selected','false'); }
      if (regForm) regForm.style.display = 'block';
      if (loginForm) loginForm.style.display = 'none';
      if (regErr) regErr.style.display = 'none';
      if (loginErr) loginErr.style.display = 'none';
    }
    function showLogin(){
      if (btnLog)  { btnLog.classList.add('active'); btnLog.setAttribute('aria-selected','true'); }
      if (btnReg)  { btnReg.classList.remove('active'); btnReg.setAttribute('aria-selected','false'); }
      if (loginForm) loginForm.style.display = 'block';
      if (regForm) regForm.style.display = 'none';
      if (regErr) regErr.style.display = 'none';
      if (loginErr) loginErr.style.display = 'none';
    }

    if (btnReg) btnReg.addEventListener('click', showRegister);
    if (btnLog) btnLog.addEventListener('click', showLogin);
    if (regCancel) regCancel.addEventListener('click', showLogin);

    // INSCRIPTION : vérification, enregistrement puis redirection
    if (regForm) regForm.addEventListener('submit', function(ev){
      ev.preventDefault();
      if (regErr) regErr.style.display = 'none';

      const pseudo = ( $('regPseudo') && $('regPseudo').value || '' ).trim();
      const email = ( $('regEmail') && $('regEmail').value || '' ).trim();
      const pass = ( $('regPassword') && $('regPassword').value || '' ).trim();

      if (!pseudo) { if (regErr){ regErr.textContent = 'Saisissez un pseudo.'; regErr.style.display='block'; } return; }
      if (!pass) { if (regErr){ regErr.textContent = 'Saisissez un mot de passe.'; regErr.style.display='block'; } return; }

      const users = loadRegistered();
      const dup = users.find(u =>
        (u.pseudo && u.pseudo.toLowerCase() === pseudo.toLowerCase()) ||
        (u.email && email && u.email.toLowerCase() === email.toLowerCase())
      );
      if (dup) {
        if (regErr){ regErr.textContent = 'Ce pseudo ou cet email est déjà utilisé.'; regErr.style.display='block'; }
        return;
      }

      const user = { id: Date.now(), pseudo: pseudo, email: email||'', password: pass, avatar: avatarFor(pseudo) };
      users.push(user);
      saveRegistered(users);

      // auto-login et redirection vers la page d'accueil
      saveCurrent({ id: user.id, pseudo: user.pseudo, avatar: user.avatar });
      const rt = getReturnTo();
      redirectTo(rt || HOME_PAGE);
    });

    // CONNEXION : strict, pas de fallback automatique
    if (loginForm) loginForm.addEventListener('submit', function(ev){
      ev.preventDefault();
      if (loginErr) loginErr.style.display = 'none';

      const identifier = ( $('logUser') && $('logUser').value || '' ).trim();
      const pass = ( $('logPassword') && $('logPassword').value || '' ).trim();

      if (!identifier) { if (loginErr){ loginErr.textContent = 'Saisissez votre pseudo ou email.'; loginErr.style.display='block'; } return; }
      if (!pass) { if (loginErr){ loginErr.textContent = 'Saisissez votre mot de passe.'; loginErr.style.display='block'; } return; }

      const users = loadRegistered();
      const found = users.find(u =>
        (
          (u.pseudo && u.pseudo.toLowerCase() === identifier.toLowerCase()) ||
          (u.email && u.email.toLowerCase() === identifier.toLowerCase())
        ) && (u.password === pass)
      );

      if (!found) {
        if (loginErr) {
          loginErr.textContent = 'Identifiants incorrects. Inscrivez‑vous d\'abord ou vérifiez vos informations.';
          loginErr.style.display = 'block';
        }
        return;
      }

      // Succès : enregistrer la session et rediriger
      saveCurrent({ id: found.id, pseudo: found.pseudo, avatar: found.avatar });
      const rt = getReturnTo();
      redirectTo(rt || HOME_PAGE);
    });

    // NE PAS rediriger automatiquement au chargement — l'utilisateur doit s'inscrire / se connecter explicitement.
    // état initial : montrer la connexion
    showLogin();
  })();
  </script>
</body>
</html>
