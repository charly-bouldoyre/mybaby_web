<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>MyBaby ‚Äî Carte</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="carte.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head>
<body>
  <header style="position:relative; z-index:1000;">
    <div class="brand">MyBaby</div>
    <nav aria-label="Navigation principale">
      <a id="openAccueil" class="nav-btn" href="Accueil.html" title="Accueil" aria-label="Accueil">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 11.5L12 4l9 7.5" />
          <path d="M5 21h14a1 1 0 0 0 1-1V11" />
          <path d="M9 21V13h6v8" />
        </svg>
        Accueil
      </a>

      <!-- Profil : ouvre profil.html (sera compl√©t√© par script avec returnTo) -->
      <a id="profileLink" class="nav-btn" href="profil.html" title="Profil" aria-label="Profil">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </svg>
        Profil
      </a>

      <a id="navMatch" class="nav-btn" href="match.html" title="Match" aria-label="Match">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
          <path d="M16 3l5 5" />
          <path d="M3 21l6-6" />
          <path d="M7 7l10 10" />
          <path d="M14 4l6 6" />
        </svg>
        Match
      </a>

      <a class="nav-btn" href="stats.html" title="Classement" aria-label="Classement">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 20V10" />
          <path d="M18 20V4" />
          <path d="M6 20v-6" />
          <path d="M3 3h18" />
        </svg>
        Classement
      </a>
    </nav>
  </header>

  <div class="container">
    <div class="map-wrap">
      <div id="map" aria-label="Carte des bars"></div>

      <div class="legend legend-bottom-left" id="mapLegend" aria-hidden="false">
        <strong>L√©gende</strong>
        <div class="legend-item">
          <svg width="18" height="18" viewBox="0 0 18 18" aria-hidden="true"><circle cx="9" cy="9" r="7" fill="#bc1515"/></svg>
          <span>Bar / Babyfoot</span>
        </div>
      </div>

      <div class="controls" role="group" aria-label="Contr√¥les carte">
        <button id="btnSearch" class="ctrl-btn">üîé Recherche</button>
        <button id="btnFilter" class="ctrl-btn">‚öôÔ∏è Filtrer</button>
        <button id="btnAdd" class="ctrl-btn">Ôºã Ajouter</button>
      </div>
    </div>
  </div>

  <div class="logo-bottom-left" aria-hidden="true">
    <svg width="84" height="84" viewBox="0 0 90 90">
      <circle cx="45" cy="45" r="40" fill="#bc1515"/>
      <text x="45" y="72" text-anchor="middle" fill="#eadec8" font-family="Arial Black" font-size="10">MYBABY</text>
    </svg>
  </div>

  <!-- Modal (r√©utilisable pour recherche/filtre/add/details) -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content" role="document">
      <button class="modal-close" id="modalClose" aria-label="Fermer">‚úï</button>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // --- Helpers ---
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // Modal helpers
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    const modalClose = document.getElementById('modalClose');
    function openModal(html){ modalBody.innerHTML = html; modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function closeModal(){ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); modalBody.innerHTML=''; document.body.style.overflow=''; }
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=> { if (e.target === modal) closeModal(); });

    // Update profile link so user can return
    (function(){
      const profileLink = document.getElementById('profileLink');
      if (!profileLink) return;
      try {
        const from = location.href || (location.pathname + (location.search || ''));
        profileLink.href = 'profil.html?returnTo=' + encodeURIComponent(from);
      } catch(e) {
        profileLink.href = 'profil.html';
      }
    })();

    // --- Data source ---
    // Load saved bars if any
    const STORAGE_BARS = 'mybaby_bars_v1';
    function loadBars() { try { return JSON.parse(localStorage.getItem(STORAGE_BARS) || '[]'); } catch(e){ return []; } }
    function saveBars(arr){ try { localStorage.setItem(STORAGE_BARS, JSON.stringify(arr)); } catch(e){} }

    // Default sample bars (will be used only if no saved bars)
    const defaultBars = [
      {id:1, name:"Bar Rouge", lat:48.8566, lng:2.3522, address:"Paris - Centre", open_now:true, photos:["https://picsum.photos/seed/bar1/800/480"]},
      {id:2, name:"Le Baby Caf√©", lat:48.8606, lng:2.3376, address:"Pr√®s du mus√©e", open_now:false, photos:["https://picsum.photos/seed/bar2/800/480","https://picsum.photos/seed/bar2b/800/480"]},
      {id:3, name:"Foosball Club", lat:48.853, lng:2.349, address:"Quartier Latin", open_now:true, photos:[]}
    ];

    let bars = loadBars();
    if (!bars || !bars.length) { bars = defaultBars.slice(); saveBars(bars); }

    // --- Map init ---
    const map = L.map('map').setView([48.8566, 2.3522], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // SVG icon
    const svgIcon = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="10" r="6" fill="#bc1515" stroke="#eadec8" stroke-width="1"/><rect x="10" y="16" width="4" height="6" rx="2" fill="#bc1515"/></svg>`);
    const redIcon = L.icon({ iconUrl: 'data:image/svg+xml;charset=UTF-8,' + svgIcon, iconSize: [36,36], iconAnchor: [18,36], popupAnchor: [0,-30] });

    // markers map: id -> marker
    const markers = new Map();

    function createPopupHtml(bar){
      const thumb = (bar.photos && bar.photos.length) ? `<img class="popup-thumb" src="${escapeHtml(bar.photos[0])}" alt="${escapeHtml(bar.name)}">` : `<div class="popup-no-thumb">Pas de photo</div>`;
      return `
        <div class="popup">
          <div class="popup-left">${thumb}</div>
          <div class="popup-right">
            <strong>${escapeHtml(bar.name)}</strong><br>
            <small>${escapeHtml(bar.address || '')}</small>
            <div class="popup-actions">
              <button class="popup-more" data-id="${bar.id}">Plus d'infos</button>
            </div>
          </div>
        </div>
      `;
    }

    function addMarker(bar){
      if (markers.has(bar.id)) return;
      if (typeof bar.lat !== 'number' || typeof bar.lng !== 'number') return;
      const m = L.marker([bar.lat, bar.lng], {icon:redIcon}).addTo(map);
      m.bindPopup(createPopupHtml(bar), {maxWidth:320});
      m.on('popupopen', () => {
        // attach click after popup DOM exists
        setTimeout(()=> {
          const btn = document.querySelector(`.popup-more[data-id="${bar.id}"]`);
          if (btn) btn.addEventListener('click', ()=> openBarModal(bar.id));
        }, 0);
      });
      markers.set(bar.id, m);
    }

    function removeMarker(barId){
      const m = markers.get(barId);
      if (m) { map.removeLayer(m); markers.delete(barId); }
    }

    function renderAllMarkers(){
      // clear existing
      markers.forEach(m => map.removeLayer(m));
      markers.clear();
      bars.forEach(addMarker);
    }

    renderAllMarkers();

    // --- Bar details modal ---
    function openBarModal(id){
      const bar = bars.find(b => b.id === Number(id));
      if (!bar) return;
      const photosHtml = (bar.photos && bar.photos.length) ? bar.photos.map(p => `<img class="detail-photo" src="${escapeHtml(p)}" alt="">`).join('') : '<div class="small-muted">Aucune photo</div>';
      const html = `
        <h2>${escapeHtml(bar.name)}</h2>
        <p><strong>Adresse :</strong> ${escapeHtml(bar.address || '‚Äî')}</p>
        <p><strong>Ouvert maintenant :</strong> ${bar.open_now ? 'Oui' : 'Non'}</p>
        <div class="detail-photos">${photosHtml}</div>
        <div style="text-align:right;margin-top:12px"><button id="closeModalBtn" class="ctrl-btn">Fermer</button></div>
      `;
      openModal(html);
      const closeBtn = document.getElementById('closeModalBtn');
      if (closeBtn) closeBtn.addEventListener('click', closeModal);
    }

    // --- Controls behaviors ---
    // Search
    document.getElementById('btnSearch').addEventListener('click', ()=> {
      openModal(`
        <h3>Recherche</h3>
        <p>Rechercher par nom ou adresse :</p>
        <input id="searchInput" type="text" placeholder="Ex : Bar Rouge" style="width:100%;padding:8px;margin-top:6px">
        <div style="text-align:right;margin-top:10px"><button id="doSearch" class="ctrl-btn">Rechercher</button> <button id="cancelSearch" class="ctrl-btn">Annuler</button></div>
      `);
      document.getElementById('cancelSearch').addEventListener('click', closeModal);
      document.getElementById('doSearch').addEventListener('click', ()=> {
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (!q) { alert('Entrez un terme de recherche'); return; }
        const results = bars.filter(b => (b.name && b.name.toLowerCase().includes(q)) || (b.address && b.address.toLowerCase().includes(q)));
        closeModal();
        if (!results.length) { alert('Aucun r√©sultat'); return; }
        if (results.length === 1) {
          const r = results[0];
          const m = markers.get(r.id);
          if (m) { map.setView([r.lat, r.lng], 16); m.openPopup(); }
        } else {
          const latlngs = results.map(r => [r.lat, r.lng]);
          try { map.fitBounds(latlngs); } catch(e) { /* ignore */ }
          const m = markers.get(results[0].id);
          if (m) m.openPopup();
        }
      });
    });

    // Filter
    let activeFilter = { onlyOpen: false };
    document.getElementById('btnFilter').addEventListener('click', ()=> {
      openModal(`
        <h3>Filtrer</h3>
        <label style="display:flex;align-items:center;gap:8px;margin-top:8px"><input id="filterOpenNow" type="checkbox"> Afficher seulement les bars ouverts maintenant</label>
        <div style="text-align:right;margin-top:12px"><button id="applyFilter" class="ctrl-btn">Appliquer</button> <button id="cancelFilter" class="ctrl-btn">Annuler</button></div>
      `);
      document.getElementById('cancelFilter').addEventListener('click', closeModal);
      document.getElementById('applyFilter').addEventListener('click', ()=> {
        const onlyOpen = document.getElementById('filterOpenNow').checked;
        activeFilter.onlyOpen = onlyOpen;
        // show/hide markers accordingly
        markers.forEach((marker, id) => {
          const bar = bars.find(b => b.id === id);
          if (!bar) return;
          if (onlyOpen && !bar.open_now) {
            if (map.hasLayer(marker)) map.removeLayer(marker);
          } else {
            if (!map.hasLayer(marker)) marker.addTo(map);
          }
        });
        closeModal();
      });
    });

    // Add bar
    document.getElementById('btnAdd').addEventListener('click', ()=> {
      openModal(`
        <h3>Ajouter un bar</h3>
        <label>Nom<br><input id="addName" type="text" style="width:100%;padding:8px;margin-top:6px"></label>
        <label>Adresse<br><input id="addAddress" type="text" style="width:100%;padding:8px;margin-top:6px"></label>
        <label>Photos (URLs, s√©par√©es par des virgules)<br><input id="addPhotos" type="text" style="width:100%;padding:8px;margin-top:6px" placeholder="https://..., https://..."></label>
        <label style="display:flex;align-items:center;gap:8px;margin-top:8px"><input id="addOpenNow" type="checkbox"> Ouvert maintenant</label>
        <p style="font-size:0.9rem;color:#444">Vous pouvez cliquer sur la carte pour d√©finir la position (bouton ci‚Äëdessous).</p>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="setOnMap" class="ctrl-btn">D√©finir position sur la carte</button>
          <button id="doAdd" class="ctrl-btn">Ajouter</button>
          <button id="cancelAdd" class="ctrl-btn">Annuler</button>
        </div>
      `);

      let tempLatLng = null;
      let mapClickHandler = null;

      document.getElementById('cancelAdd').addEventListener('click', ()=> {
        if (mapClickHandler) map.off('click', mapClickHandler);
        closeModal();
      });

      document.getElementById('setOnMap').addEventListener('click', ()=> {
        alert('Cliquez maintenant sur la carte pour s√©lectionner la position du nouveau bar.');
        mapClickHandler = function(e){
          tempLatLng = e.latlng;
          // show a temporary marker preview
          const preview = L.marker(tempLatLng).addTo(map);
          preview.bindPopup('Position s√©lectionn√©e').openPopup();
          setTimeout(()=> map.removeLayer(preview), 3000);
          map.off('click', mapClickHandler);
        };
        map.on('click', mapClickHandler);
      });

      document.getElementById('doAdd').addEventListener('click', ()=> {
        const name = document.getElementById('addName').value.trim();
        const address = document.getElementById('addAddress').value.trim();
        const photosRaw = document.getElementById('addPhotos').value.trim();
        const photos = photosRaw ? photosRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
        const openNow = document.getElementById('addOpenNow').checked;

        if (!tempLatLng) {
          const latStr = prompt('Entrez la latitude (ex : 48.8566) :');
          const lngStr = prompt('Entrez la longitude (ex : 2.3522) :');
          if (!latStr || !lngStr) return alert('Position requise pour ajouter le bar.');
          tempLatLng = { lat: parseFloat(latStr), lng: parseFloat(lngStr) };
          if (isNaN(tempLatLng.lat) || isNaN(tempLatLng.lng)) return alert('Latitude/longitude invalides.');
        }

        if (!name) return alert('Le nom est requis.');
        const newId = bars.reduce((m,b)=> Math.max(m,b.id), 0) + 1;
        const newBar = { id:newId, name, address, lat: tempLatLng.lat, lng: tempLatLng.lng, open_now: openNow, photos };
        bars.push(newBar);
        saveBars(bars);
        addMarker(newBar);
        closeModal();
        map.setView([newBar.lat, newBar.lng], 16);
        const m = markers.get(newBar.id);
        if (m) m.openPopup();
      });
    });

    // Ensure markers visibility respects current filter after page load / add
    function applyActiveFilter(){
      markers.forEach((marker, id) => {
        const bar = bars.find(b => b.id === id);
        if (!bar) return;
        if (activeFilter.onlyOpen && !bar.open_now) {
          if (map.hasLayer(marker)) map.removeLayer(marker);
        } else {
          if (!map.hasLayer(marker)) marker.addTo(map);
        }
      });
    }

    // Reapply filter when map loaded / markers updated
    map.on('load', applyActiveFilter);

    // Expose a small debug in console
    console.log('Carte initialis√©e ‚Äî marqueurs:', bars.length);
  </script>

  <!-- Ajout : forcer toute r√©f√©rence "duel" -> "match" et s'assurer que le lien Match ouvre match.html?returnTo=<origine> -->
  <script>
  (function(){
    const destBase = 'match.html';
    const makeDest = () => destBase + '?returnTo=' + encodeURIComponent(location.href);

    function isDuelHref(h){
      if (!h) return false;
      const s = h.trim().toLowerCase().split(/[?#]/)[0];
      return s === 'duel' || s === 'duel.html' || s.endsWith('/duel') || s.endsWith('/duel.html') || s.includes('/duel.');
    }

    // Replace href attributes that reference duel -> match (so middle-click / copy link are correct)
    document.querySelectorAll('a[href]').forEach(a=>{
      try {
        const href = a.getAttribute('href') || '';
        if (isDuelHref(href)) {
          a.setAttribute('href', makeDest());
          a.dataset._matchFixed = '1';
        }
      } catch(e){}
    });

    // Also ensure the navMatch anchor uses match.html?returnTo=...
    try {
      const navMatch = document.getElementById('navMatch');
      if (navMatch) navMatch.setAttribute('href', makeDest());
    } catch(e){}

    // Capture-phase click interception to force redirect to match.html?returnTo=... before browser follows any old href
    document.addEventListener('click', function(e){
      try {
        if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return; // allow modifier clicks

        const el = e.target.closest && e.target.closest('a, button, [role="button"]');
        if (!el) return;

        // If it's an anchor pointing to duel -> prevent and redirect
        if (el.tagName === 'A') {
          const href = (el.getAttribute('href') || '').toLowerCase();
          if (isDuelHref(href)) {
            e.preventDefault();
            const d = makeDest();
            try { el.setAttribute('href', d); } catch(_) {}
            window.location.href = d;
            return;
          }
          // If anchor text/id mentions "match" but href still points elsewhere, redirect
          const txt = (el.textContent||'').trim().toLowerCase();
          const id = (el.id||'').toLowerCase();
          if ((txt && txt.includes('match')) && !href.includes('match.html')) {
            e.preventDefault();
            const d = makeDest();
            try { el.setAttribute('href', d); } catch(_) {}
            window.location.href = d;
            return;
          }
        }

        // For non-anchor elements (buttons) that indicate "match"
        const id = (el.id||'').toLowerCase();
        const txt = (el.textContent||'').trim().toLowerCase();
        if (el.tagName !== 'A' && (id.includes('match') || txt === 'match' || txt.includes('match'))) {
          e.preventDefault();
          window.location.href = makeDest();
          return;
        }
      } catch(err){
        // do not break the page
        console.error(err);
      }
    }, true); // capture phase
  })();
  </script>

  <!-- Ajout : ouvrir classement.html quand on clique sur "Classement" -->
  <script>
  (function(){
    'use strict';
    const DEST = 'classement.html';
    const makeDest = () => DEST + '?returnTo=' + encodeURIComponent(location.href);

    function mentionsClassement(s){
      if (!s) return false;
      return String(s).toLowerCase().includes('classement') || String(s).toLowerCase().includes('statistique');
    }

    // Mettre √† jour les ancres existantes (pour middle-click / copier le lien)
    try {
      document.querySelectorAll('a[href]').forEach(a=>{
        try {
          const href = a.getAttribute('href') || '';
          const txt = a.textContent || '';
          const title = a.getAttribute && (a.getAttribute('title') || '');
          const aria = a.getAttribute && (a.getAttribute('aria-label') || '');
          if (mentionsClassement(href) || mentionsClassement(txt) || mentionsClassement(title) || mentionsClassement(aria)) {
            a.setAttribute('href', makeDest());
            a.dataset._classementFixed = '1';
          }
        } catch (e){}
      });
    } catch (e){}

    // D√©l√©gation : intercepter les clics sur √©l√©ments mentionnant "Classement" et ouvrir la page
    document.addEventListener('click', function(e){
      try {
        if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return; // allow modifier clicks
        const el = e.target.closest && e.target.closest('a, button, [role="button"], [data-action]');
        if (!el) return;

        const txt = (el.textContent || '').trim();
        const title = el.getAttribute && (el.getAttribute('title') || '');
        const aria = el.getAttribute && (el.getAttribute('aria-label') || '');
        if (mentionsClassement(txt) || mentionsClassement(title) || mentionsClassement(aria)) {
          e.preventDefault();
          if (el.tagName === 'A') {
            try { el.setAttribute('href', makeDest()); } catch(_) {}
          }
          window.location.href = makeDest();
        }
      } catch (err) {
        console.error(err);
      }
    }, true);
  })();
  </script>
</body>
</html>
  ...
 
