<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>MyBaby — Profil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="profil.css">
</head>
<body>
  <header>
    <div class="brand">MyBaby — Profil</div>
    <nav aria-label="Navigation">
      <a id="linkAccueil" class="nav-btn" href="Accueil.html" title="Accueil" aria-label="Accueil">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 11.5L12 4l9 7.5"></path>
          <path d="M5 21h14a1 1 0 0 0 1-1V11"></path>
          <path d="M9 21V13h6v8"></path>
        </svg>
        Accueil
      </a>

      <a id="linkCarte" class="nav-btn" href="carte.html" title="Carte" aria-label="Carte">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 11.5L12 4l9 7.5"></path>
          <path d="M5 21h14a1 1 0 0 0 1-1V11"></path>
          <path d="M9 21V13h6v8"></path>
        </svg>
        Carte
      </a>

      <a id="linkMatch" class="nav-btn" href="match.html" title="Match" aria-label="Match">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
          <path d="M16 3l5 5"></path>
          <path d="M3 21l6-6"></path>
          <path d="M7 7l10 10"></path>
          <path d="M14 4l6 6"></path>
        </svg>
        Match
      </a>

      <a id="linkStats" class="nav-btn" href="stats.html" title="Classement" aria-label="Classement">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 20V10"></path>
          <path d="M18 20V4"></path>
          <path d="M6 20v-6"></path>
          <path d="M3 3h18"></path>
        </svg>
        Classement
      </a>
    </nav>
  </header>

  <main class="container" role="main">
    <div class="row">
      <section class="card col-left" aria-labelledby="profile-heading">
        <h2 id="profile-heading">Photo de profil</h2>
        <div class="avatar-wrap">
          <div class="avatar" id="avatarPreview" aria-hidden="false">
            <div class="placeholder">Aucune image</div>
          </div>
          <div class="upload-area">
            <label for="avatarInput" class="label-bold">Télécharger une photo</label>
            <input id="avatarInput" type="file" accept="image/*" aria-label="Télécharger une photo de profil">
            <p class="helper">La photo est prévisualisée localement et sauvegardée dans le navigateur (localStorage).</p>
            <button id="removeAvatar" class="btn secondary" type="button">Supprimer la photo</button>
          </div>
        </div>
      </section>

      <section class="card col-right" aria-labelledby="infos-heading">
        <h2 id="infos-heading">Informations utilisateur</h2>

        <form id="profileForm" onsubmit="return false;" aria-describedby="profile-help">
          <p id="profile-help" class="helper">Modifie tes informations puis clique sur "Enregistrer".</p>

          <div class="field"><label for="pseudo">Pseudo</label><input id="pseudo" type="text" placeholder="Ton pseudo" required></div>
          <div class="field"><label for="email">Adresse mail</label><input id="email" type="email" placeholder="exemple@mail.com" required></div>
          <div class="field"><label for="status">Statut</label><select id="status" aria-label="Statut utilisateur"><option value="joueur">Joueur</option><option value="organisateur">Organisateur</option><option value="admin">Admin</option></select></div>
          <div class="field"><label for="affiliation">Affiliation</label><input id="affiliation" type="text" placeholder="Club / Association (optionnel)"></div>

          <div class="actions" role="group" aria-label="Actions profil">
            <button id="saveProfile" class="btn" type="button">Enregistrer</button>
            <button id="resetProfile" class="btn secondary" type="button">Réinitialiser</button>
            <button id="returnAccueil" class="btn ghost" type="button" title="Retour à l'accueil">← Retour</button>
          </div>
        </form>

        <hr class="divider">

        <h3 class="section-title">Ajout des bars</h3>
        <p class="helper">Ajouter un bar / babyfoot à ta liste personnelle. Tu peux ensuite ouvrir la carte dans Accueil pour voir les lieux ajoutés.</p>

        <div class="bar-actions">
          <button id="addBarBtn" class="btn secondary" type="button">＋ Ajouter un bar</button>
          <button id="clearBars" class="btn secondary" type="button">Supprimer tous les bars</button>
          <button id="openCarte" class="btn" type="button">Ouvrir la carte</button>
        </div>

        <div class="bars-list" id="barsList" aria-live="polite"></div>
      </section>
    </div>
  </main>

  <script>
    // Gestion utilisateur (localStorage)
    const STORAGE_USER = 'mybaby_user';
    const STORAGE_BARS = 'mybaby_added_bars';
    // === BACKEND ===
const API_URL = "http://localhost:3000/users";

// on récupère l'id dans l'URL : profil.html?id=1
const params = new URLSearchParams(window.location.search);
const userId = params.get("id");

if (!userId) {
  alert("⚠️ Ouvre la page avec ?id=1 (ex: profil.html?id=1)");
}


    // DOM
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const removeAvatar = document.getElementById('removeAvatar');

    const pseudoInput = document.getElementById('pseudo');
    const emailInput = document.getElementById('email');
    const statusInput = document.getElementById('status');
    const affiliationInput = document.getElementById('affiliation');

    const saveBtn = document.getElementById('saveProfile');
    const resetBtn = document.getElementById('resetProfile');
    const returnBtn = document.getElementById('returnAccueil');

    const addBarBtn = document.getElementById('addBarBtn');
    const clearBarsBtn = document.getElementById('clearBars');
    const barsList = document.getElementById('barsList');
    const openCarteBtn = document.getElementById('openCarte');

    function loadJSON(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch (e) { return fallback; } }
    function saveJSON(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.warn('Impossible de sauvegarder', e); } }

    const defaultUser = { pseudo: '', email: '', status: 'joueur', affiliation: '', avatarDataUrl: '' };
    let user = loadJSON(STORAGE_USER, defaultUser);
    let bars = loadJSON(STORAGE_BARS, []);

    function renderAvatar() {
      avatarPreview.innerHTML = '';
      if (user.avatarDataUrl) {
        const img = document.createElement('img');
        img.src = user.avatarDataUrl;
        img.alt = user.pseudo ? (user.pseudo + " — photo de profil") : "Photo de profil";
        avatarPreview.appendChild(img);
      } else {
        const ph = document.createElement('div');
        ph.className = 'placeholder';
        ph.textContent = 'Aucune image';
        avatarPreview.appendChild(ph);
      }
    }

    async function loadProfileFromBackend() {
  try {
    const res = await fetch(`${API_URL}/${userId}/profile`);
    const backendUser = await res.json();

    pseudoInput.value = backendUser.pseudo || '';
    emailInput.value = backendUser.email || '';
    statusInput.value = backendUser.status || 'joueur';
    affiliationInput.value = backendUser.affiliation || '';
  } catch (e) {
    console.error(e);
    alert("Erreur lors du chargement du profil");
  }
}


    function renderBarsList() {
      barsList.innerHTML = '';
      if (!bars || bars.length === 0) {
        const info = document.createElement('div'); info.style.color = '#666'; info.textContent = 'Aucun bar ajouté.'; barsList.appendChild(info); return;
      }
      bars.slice().reverse().forEach(b => {
        const item = document.createElement('div'); item.className = 'bar-item';
        const left = document.createElement('div'); left.innerHTML = `<strong>${escapeHtml(b.name)}</strong><div class="small-muted">${escapeHtml(b.address || '')}</div>`;
        const right = document.createElement('div'); right.style.display = 'flex'; right.style.gap = '8px';
        const goto = document.createElement('button'); goto.className = 'btn secondary'; goto.textContent = 'Voir sur la carte';
        // redirige désormais vers carte.html (au lieu d'Accueil.html)
        goto.addEventListener('click', ()=> { saveJSON('mybaby_last_open_bar', b); window.location.href = 'carte.html'; });
        const remove = document.createElement('button'); remove.className = 'btn'; remove.style.background = '#c33'; remove.textContent = 'Supprimer';
        remove.addEventListener('click', ()=> { bars = bars.filter(x => x.id !== b.id); saveJSON(STORAGE_BARS, bars); renderBarsList(); });
        right.appendChild(goto); right.appendChild(remove); item.appendChild(left); item.appendChild(right); barsList.appendChild(item);
      });
    }

    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

   // Initial render
    renderAvatar();
    loadProfileFromBackend();
    renderBarsList();


    // Avatar upload
    avatarInput.addEventListener('change', (e)=> {
      const f = e.target.files && e.target.files[0]; if (!f) return;
      const fr = new FileReader(); fr.onload = () => { user.avatarDataUrl = fr.result; saveJSON(STORAGE_USER, user); renderAvatar(); }; fr.readAsDataURL(f);
    });
    removeAvatar.addEventListener('click', ()=> { user.avatarDataUrl = ''; saveJSON(STORAGE_USER, user); renderAvatar(); });

   // Save profile → BACKEND
    saveBtn.addEventListener("click", async () => {
      try {
        const body = {
          pseudo: pseudoInput.value.trim(),
          email: emailInput.value.trim(),
          status: statusInput.value,
          affiliation: affiliationInput.value.trim()
        };
    
        const res = await fetch(`${API_URL}/${userId}/profile`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });
    
        if (!res.ok) {
          alert("❌ Erreur lors de la sauvegarde");
          return;
        }
    
        alert("✅ Profil sauvegardé en base");
      } catch (e) {
        console.error(e);
        alert("❌ Erreur serveur");
      }
    });

    // Reset
    resetBtn.addEventListener('click', ()=> {
      if (!confirm('Réinitialiser les informations utilisateur ?')) return;
      user = Object.assign({}, defaultUser); saveJSON(STORAGE_USER, user); renderProfileFields(); renderAvatar();
    });

    // Add / clear bars
    addBarBtn.addEventListener('click', ()=> {
      const name = prompt('Nom du bar / babyfoot ?'); if(!name) return;
      const address = prompt('Adresse / description (optionnel) :') || '';
      const lat = parseFloat(prompt('Latitude (ex: 48.8566) :') || ''); const lng = parseFloat(prompt('Longitude (ex : 2.3522) :') || '');
      if (isNaN(lat) || isNaN(lng)) { if (!confirm('Coordonnées invalides. Ajouter sans coordonnées ? (OK = oui, Annuler = non)')) return; }
      const newBar = { id: Date.now(), name: name, address: address, lat: isNaN(lat)? null : lat, lng: isNaN(lng)? null : lng, addedAt: new Date().toISOString() };
      bars.push(newBar); saveJSON(STORAGE_BARS, bars); renderBarsList(); alert('Bar ajouté localement. Ouvre la carte (Accueil) pour l’afficher.');
    });

    clearBarsBtn.addEventListener('click', ()=> {
      if (!confirm('Supprimer tous les bars ajoutés localement ?')) return;
      bars = []; saveJSON(STORAGE_BARS, bars); renderBarsList();
    });

    // debug + navigation robuste vers carte.html
    openCarteBtn.addEventListener('click', () => {
      try {
        console.log('[DEBUG] Clic sur Ouvrir la carte');
        // calcule l'URL relative correctement (fonctionne aussi en file://)
        const target = new URL('carte.html', location.href).href;
        console.log('[DEBUG] Navigation vers :', target);
        // utilise assign() pour garder l'historique
        window.location.assign(target);
      } catch (err) {
        console.error('[DEBUG] Erreur navigation vers carte.html', err);
        // fallback simple
        window.location.href = 'carte.html';
      }
    });

    // Return button behavior (uses optional returnTo param)
    function getQueryParam(name){ try { const params = new URLSearchParams(location.search); return params.get(name); } catch(e) { return null; } }
    const returnTo = getQueryParam('returnTo');

    returnBtn.addEventListener('click', ()=> {
      try {
        if (returnTo) { window.location.href = decodeURIComponent(returnTo); return; }
        if (window.history && window.history.length > 1) { window.history.back(); setTimeout(()=> { window.location.href = 'Accueil.html'; }, 400); } else { window.location.href = 'Accueil.html'; }
      } catch (e) { window.location.href = 'Accueil.html'; }
    });
  </script>

  <!-- Script ajouté : ouvrir classement.html quand on clique sur "Classement" -->
  <script>
  (function(){
    'use strict';
    const DEST = 'classement.html';
    const makeDest = () => DEST + '?returnTo=' + encodeURIComponent(location.href);

    function mentionsClassement(s){
      if (!s) return false;
      return String(s).toLowerCase().includes('classement') || String(s).toLowerCase().includes('statistique');
    }

    // Mettre à jour les ancres existantes (pour middle-click / copier le lien)
    try {
      document.querySelectorAll('a[href]').forEach(a=>{
        try {
          const href = a.getAttribute('href') || '';
          const txt = a.textContent || '';
          const title = a.getAttribute && (a.getAttribute('title') || '');
          const aria = a.getAttribute && (a.getAttribute('aria-label') || '');
          if (mentionsClassement(href) || mentionsClassement(txt) || mentionsClassement(title) || mentionsClassement(aria)) {
            a.setAttribute('href', makeDest());
            a.dataset._classementFixed = '1';
          }
        } catch (e){}
      });
    } catch (e){}

    // Délégation : intercepter les clics sur éléments mentionnant "Classement" et ouvrir la page
    document.addEventListener('click', function(e){
      try {
        if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return; // allow modifier clicks
        const el = e.target.closest && e.target.closest('a, button, [role="button"], [data-action]');
        if (!el) return;

        const txt = (el.textContent || '').trim();
        const title = el.getAttribute && (el.getAttribute('title') || '');
        const aria = el.getAttribute && (el.getAttribute('aria-label') || '');
        if (mentionsClassement(txt) || mentionsClassement(title) || mentionsClassement(aria)) {
          e.preventDefault();
          if (el.tagName === 'A') {
            try { el.setAttribute('href', makeDest()); } catch(_) {}
          }
          window.location.href = makeDest();
        }
      } catch (err) {
        console.error(err);
      }
    }, true);
  })();
  </script>
</body>
</html>
